# 第2章 从剖析两个高并发系统开始

## 2.1 案例一：千万级流量“秒杀”系统

### 2.1.1 系统设计概况

1. 秒杀系统的特点
    - 业务特点：限时/限量/限价、活动预热、持续时间短。
    - 技术特点：瞬时并发量高、并发读写。

2. “秒杀”活动的设计原则
    - 数据应尽量少
    - 请求数应尽量少
    - 请求路径应尽量短
    - 尽量使用“异步化”
    - 避免单节点

### 2.1.2 动静分离方案设计

- 静态数据：CSS和JS文件中的静态数据、图片等相关资源文件、其他与用户信息无关的静态数据。
- 动态数据：依据当前用户属性动态生成的数据。
- “页面静态化”技术：直接缓存HTTP连接。
- 热点数据：静态热点数据（可以被提前预知）、动态热点数据（不能被提前预知）

### 2.1.3 流量控制

- CDN层：提前生成尽可能多的数据，将其放入CDN节点缓存中。
- 反向代理层：将后端生成好前端需要的静态数据，分发给所有反向代理服务器。
- 后端服务层：当“到达系统中的请求数”明显大于“系统能够处理的最大请求数”时，直接拒绝多余的请求，返回“秒杀”活动结束的信息。
- 数据库层：数据库配置为读写分离，尝试去除行锁。

### 2.1.4 技术梳理

- 数据的静态化技术：各层级缓存的处理（多级缓存技术）、分布式缓存技术
- 负载均衡反向代理技术：LVS、Nginx
- 异步处理技术：消息队列技术、排队系统技术
- 系统架构设计：系统模块化划分、微服务架构思想
- 系统监控：日志监控、服务监控

## 2.2 C2C二手电商平台的社会化治理系统

### 2.2.1 系统需求

- 用户可以对某个商品或某个评论向平台发起举报。
- 平台受理用户的举报，选出一定数量的近期活跃或者经常活跃的用户作为裁判，由他们裁判当前举报是否有效。
- 如果大部分裁判都判定此举报有效，平台判断该举报有效，反之则举报无效。

### 2.2.2 系统服务

- 基础服务治理：基于Nacos提供的服务注册中心，管理微服务。
- RPC框架服务通信：客户端和服务端按照约定的通信协议进行序列化网络通信。
- 常见的网络模型：
    - 同步阻塞I/O：在客户端发送请求后，该请求会在内核中阻塞，直到服务端的响应数据到来后，才进行后续处理。
    - 同步非阻塞I/O：在客户端每次发送请求时，在内核空间中，即使没有等到响应数据也不会阻塞，继续往下执行。
    - I/O多路复用：实现单线程同时处理多个客户端的请求，通过I/O多路复用技术将多个I/O通道复用到一个复用器上。
    - 异步非阻塞I/O：客户端在发起一个I/O操作后，不需要等待直接返回。
- 分布式事务管理：
    - 基于XA协议的二阶段提交：分为准备阶段和提交阶段。
    - 基于消息的最终一致性：遵从`BASE`理论。