# 第8章 存储系统设计

## 8.1 池化技术

- 概念：由系统预先分配一些资源并循环利用，解决由于大量分配资源导致性能开销过大的问题。
- 使用线程池的优点：
    - 解决线程生命周期的系统开销问题，加快响应速度。
    - 统筹内存和CPU的使用。
    - 统一管理资源。

## 8.2 数据库设计

- 数据库的主从架构：主从复制、主从延迟、一主多从。
- 主从数据同步：
    1. 主库提交事务，更新存储引擎中的数据。
    2. 主库将`Binlog`文件写入磁盘。
    3. 主库给客户端返回响应结果。
    4. `Binlog`文件被复制到所有的从库中。
    5. 每个从库将复制过来的`Binlog`文件写入中继日志中。
    6. 从库回放`Binlog`文件，更新存储引擎中的数据，然后给主库返回复制成功的结果。
- 读写分离：提升数据库并发能力，保证数据库的可用性。
- 分库分表：
    - 垂直拆分：按照业务模型，将相似的表或业务耦合度较高的表拆分到独立的库中。
    - 水平拆分：按照某种算法规则，将单张数据表的数据拆分到多个数据库和数据表中。
    
> **Snowflake算法**  
> - 由64bit二进制数组成，分为4个部分：第1位（默认不使用）、41位时间戳、10位机器ID、12位序列号 
> - 含义说明：
>   - 41位时间戳，可以支撑约70年。
>   - 10位机器ID，可以分为两个部分，包括2\~3位的IDC号（支撑4\~8个IDC机房）、7\~8位机器ID（可以支撑128\~256台机器）。
>   - 12位序号代表每个节点每毫秒可以生成4096个ID。

## 8.3 NoSQL数据库

- 常见数据库分类：KV数据库（`Redis`、`Memcached`等）、文档型数据库（`MongoDB`、`CouchDB`等）、列式数据库（`HBase`、`Cassandra`等）
- 存储方式：基于LSM树，在写入数据时，会先写入内存的`active MemTable`中，其中保存最近更新的数据，通过WAL的方式将数据备份到磁盘上，保证数据的可靠性。

