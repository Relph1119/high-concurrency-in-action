# 第11章 微服务设计——将系统拆分

## 11.1 对已有系统进行微服务改造

1. 圈表：按照业务维度将相同业务的表圈定在一起，对服务边界进行划分。
2. 收集SQL语句：包括业务场景、访问频率等。
3. 拆分SQL语句：切断各个服务表之间的直接联系。
4. 构建微服务：接口设计、代码开发、功能测试、自动化测试。
5. 接入微服务：将SQL语句替换成微服务，通过微服务操作对应服务的数据库。
6. 数据库独立：从物理层面切断业务团队对数据库的直接依赖。

## 11.2 微服务设计

### 11.2.1 架构分层设计

- 网关层：统一对外提供HTTP接口服务，用于实现统一的鉴权、流控和降级等功能。
- 业务聚合层：进行所有业务的逻辑处理。
- 中心服务层：独立的原子业务功能，具备高内聚、低耦合特性。
- 数据服务层：只提供对业务数据的读操作，不提供写操作。
- 存储层：只提供业务数据存储服务。

### 11.2.2 微服务的使用模式

- 事件溯源：将用户请求整个过程中的每一次状态变化记录到事件日志中，并以时间序列的方式进行持久化存储。
- 命令与查询职责隔离（CQRS）：接口服务层将查询操作和命令操作隔离，在服务层实现读写分离。
- 断路器：对出现故障的服务进行隔离。
- 超时：设置服务超时时间。